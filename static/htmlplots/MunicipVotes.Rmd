---
title: "Japanese General Elections"
#subtitle: "Exploratory Analysis"
author: "Populism in Regional Japan: Where is the 'Revenge of the Places That Don't Matter'?"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  rmdformats::readthedown:
    toc_depth: 3
---


```{r results='hide', echo=FALSE, include=FALSE}
p_needed <- c("tidyverse",
              "here",
              "cowplot",
              "readxl",
              "data.table",
              "magrittr",
              "rvest",
              "htmltab",
              "xml2",
              "gt",
              "lme4",
              "gtsummary",
              "gtExtras",
              "crosstable",
              "rmdformats",
              "ggcorrplot",
              "texreg",
              "plm",
              "sf",
              "spdep",
              "ggthemes",
              "ggpubr",
              "ggrepel",
              "ggsflabel",
              "ggspatial",
              "splm",
              "spatialreg",
              "viridis",
              "modelsummary",
              "kableExtra"
)
packages <- rownames(installed.packages())
p_to_install <- p_needed[!(p_needed %in% packages)]
if (length(p_to_install) > 0) {
  install.packages(p_to_install,
                   repos = "http://cran.us.r-project.org")
}
lapply(p_needed, require, character.only = TRUE)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
Elections <- read_csv(here("static", "htmlplots", "Data", "Elections2.csv"), col_names = TRUE)
```

```{r echo=FALSE}

# Elections <- Elections[,-c(5,8)]
Elections[, 5:7][Elections[, 5:7] == 0] <- NA

Elections2 <- Elections %>%
  filter(LDP>=0 | LDP %in% NA) %>%
  filter(LDP <=1 | LDP %in% NA) %>%
  filter(JCP>=0 | JCP %in% NA) %>%
  filter(JCP <=1 | JCP %in% NA)

Elections2$Year <- as.character(Elections2$Year)
Elections2$Year <- as.factor(Elections2$Year)

Elections2$Code <- as.character(Elections2$Code)
Elections2$Code <- as.factor(Elections2$Code)

Elections2 <- Elections2 %>%
  filter(!Code %in% NA) %>%
  mutate(Turnout = ifelse(Turnout >=1, NA, Turnout),
         EldPop = EldPop/100)

Elections3 <- Elections2[!duplicated(Elections2[,1:2]),]

# Elections4 <- Elections3 %>%
#   group_by(kuname) %>%
#   filter(all(c("全部過疎", "Normal") %in% Kaso))

# Elections5 <- Elections3 %>%
#   group_by(kuname) %>%
#   filter(all(c("全部過疎", "Normal", "一部過疎") %in% Kaso))

# https://stackoverflow.com/a/58207744
```


```{r include=FALSE}
Elections3 %>%
  group_by(Year) %>%
  summarise(n = n())
```


```{r include=FALSE}
# average municip per SMD

Elections3 %>%
#  filter(Year %in% 2021) %>%
  group_by(Year, kuname) %>%
  summarise(n = n()) %>%
  summarise(avgMun = mean(n))


# having both kaso and normal

Elections3 %>%
#  filter(Year %in% 2021) %>%
  group_by(Year, kuname) %>%
  filter(all(c('Normal','Kaso') %in% Kaso2)) %>%
  summarise(n = n()) %>%
  summarise(n = n())
```


```{r echo=FALSE}
my_pal <- scales::col_numeric(
  paletteer::paletteer_d(
    palette = "ggsci::red_material"
    ) %>% as.character(),
  domain = NULL
  )

```


# Exploratory tables

## Overall yearly trends

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(!Year %in% 2009) %>%
  group_by(Year) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt() %>%
  fmt_number(
    columns = 3:12,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
  ) %>%
    data_color(
    columns = 2:12,
    colors = my_pal
    )
```



## Basic differences between "merged" and "non-merged"


```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(!Year %in% 2009) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
  group_by(Year, Fusion) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Fusion") %>%
  fmt_number(
    columns = 3:13,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
  ) %>%
    data_color(
    columns = 2:13,
    colors = my_pal
    )
#   gtsave(
#     "merged.png"
# )
```

<br><br>

## Fiscal differences

### Merged / non-merged counts and proportions across kaso-types 

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE, include=FALSE}
Elections3 %>%
  select(Year, Fusion, Kaso) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
  tbl_summary(
    by = Year, # split table by group
    missing = "no" # don't list missing data separately
  ) %>%
  add_overall() %>%
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 
```

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
# Elections3 %>%
#   filter(Year %in% 2009,
#          Kaso %in% c("Normal", "みなし過疎", 
#                      "一部過疎", "全部過疎")) %>%
#   select(Year, Fusion, Kaso) %>%
#   mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
#                       labels = c("Non-Merged", "Merged"))) %>%
#   tbl_cross(
#     row = Fusion,
#     col = Kaso,
#     percent = "column",
#     label = list(Kaso ~ "2009", Fusion ~ "Fusion")
#   )

Elections3 %>%
  filter(Year %in% 2012) %>%
  select(Year, Fusion, Kaso) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
    mutate(Kaso = factor(Kaso, levels = c("Normal",
                                        "みなし過疎",
                                        "一部過疎",
                                        "全部過疎"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating"))) %>%
  tbl_cross(
    row = Fusion,
    col = Kaso,
    percent = "column",
    label = list(Kaso ~ "2012", Fusion ~ "Fusion")
  )

Elections3 %>%
  filter(Year %in% 2014) %>%
  select(Year, Fusion, Kaso) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
    mutate(Kaso = factor(Kaso, levels = c("Normal",
                                        "みなし過疎",
                                        "一部過疎",
                                        "全部過疎"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating"))) %>%
  tbl_cross(
    row = Fusion,
    col = Kaso,
    percent = "column",
    label = list(Kaso ~ "2014", Fusion ~ "Fusion")
  )

Elections3 %>%
  filter(Year %in% 2017) %>%
  select(Year, Fusion, Kaso) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
    mutate(Kaso = factor(Kaso, levels = c("Normal",
                                        "みなし過疎",
                                        "一部過疎",
                                        "全部過疎"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating"))) %>%
  tbl_cross(
    row = Fusion,
    col = Kaso,
    percent = "column",
    label = list(Kaso ~ "2017", Fusion ~ "Fusion")
  )

Elections3 %>%
  filter(Year %in% 2021) %>%
  select(Year, Fusion, Kaso) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
    mutate(Kaso = factor(Kaso, levels = c("Normal",
                                        "みなし過疎",
                                        "一部過疎",
                                        "全部過疎"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating"))) %>%
  tbl_cross(
    row = Fusion,
    col = Kaso,
    percent = "column",
    label = list(Kaso ~ "2021", Fusion ~ "Fusion")
  )
```

```{r include=FALSE}
# Elections3 %>%
#   select(Year, Fusion, Kaso) %>%
#   mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
#                       labels = c("Non-Merged", "Merged"))) %>%
#   crosstable(c(Fusion, Kaso), by=Year, total="both") %>%
#   as_flextable(keep_id=FALSE)
```



### Basic differences between "Normal" and "Kaso" 

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(Kaso2 %in% c("Kaso", "Normal"),
         !Year %in% 2009) %>%
  group_by(Year, Kaso2) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE), 
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso2") %>%
  fmt_number(
    columns = 3:13,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:13,
    colors = my_pal
    )
#   gtsave(
#     "kaso-nonkaso-unique.png"
# )
```


<!-- ### Basic differences between "Normal" and "Kaso" + Merged/Non-Merged -->

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE, include=FALSE}
Elections3 %>%
  filter(!Year %in% 2009) %>%
  group_by(Year, Kaso2.fusion) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                     `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                     `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                     `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                     `JCP-SMD` = mean(JCP, na.rm=TRUE),
                     `JCP-PR` = mean(JCPPR, na.rm=TRUE),
                     `JCP-Gap` = mean(JCPDif, na.rm=TRUE),
                     Turnout = mean(Turnout, na.rm=TRUE),
                     FStrength = mean(Fstrength, na.rm=TRUE),
                     LATperCapita = mean(LATperCapita, na.rm=TRUE), 
                     Elderly = mean(EldPop, na.rm=TRUE)
                     #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso2.fusion") %>%
  fmt_number(
    columns = 3:13,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(`JCP-SMD`, Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:13,
    colors = my_pal
    )
```


<br><br>

### Detailed differences (including types of "Kaso")

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(Kaso %in% c("Normal", "みなし過疎", 
                     "一部過疎", "全部過疎"),
         !Year %in% 2009) %>%
  mutate(Kaso = factor(Kaso, levels = c("Normal",
                                        "みなし過疎",
                                        "一部過疎",
                                        "全部過疎"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating"))) %>%
  group_by(Year, Kaso) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso") %>%
  fmt_number(
    columns = 3:13,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:13,
    colors = my_pal
    )
#   gtsave(
#     "kaso-detailed-unique.png"
# )
```



<br><br>

### Detailed differences (including types of "Kaso") + Merged/Non-Merged

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(Kaso.fusion %in% c("Normal", "みなし過疎", 
                     "一部過疎", "全部過疎", "全部過疎-Merged"),
         !Year %in% 2009) %>%
  mutate(Kaso.fusion = factor(Kaso.fusion, levels = c("Normal",
                                                           "みなし過疎",
                                                           "一部過疎",
                                                           "全部過疎",
                                                           "全部過疎-Merged"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating",
                                 "Fully depopulating (merged)"))) %>%
  group_by(Year, Kaso.fusion) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm = TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE),
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso.fusion") %>%
  fmt_number(
    columns = 3:13,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:13,
    colors = my_pal
    )
#   gtsave(
#     "kaso-merged-detailed-unique.png"
# )
```

<br><br>

## 2012 -- 2021 trends

## Basic differences between "merged" and "non-merged"

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(!Year %in% 2009) %>%
  mutate(Fusion = factor(Fusion, levels = c("0", "1"), 
                      labels = c("Non-Merged", "Merged"))) %>%
  group_by(Fusion) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Fusion") %>%
  fmt_number(
    columns = 2:12,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
  ) %>%
    data_color(
    columns = 2:12,
    colors = my_pal
    )
#   gtsave(
#     "merged-overall.png"
# )
```


### Basic differences between "Normal" and "Kaso"

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(Kaso2 %in% c("Kaso", "Normal"),
         !Year %in% 2009) %>%
  group_by(Kaso2) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso2") %>%
  fmt_number(
    columns = 2:12,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:12,
    colors = my_pal
    )
#   gtsave(
#     "kaso-nonkaso-overall.png"
# )
```

### Detailed differences (including types of "Kaso") + Merged/Non-Merged

```{r echo=FALSE, results='asis', message=FALSE, warning=FALSE}
Elections3 %>%
  filter(Kaso.fusion %in% c("Normal", "みなし過疎", 
                     "一部過疎", "全部過疎", "全部過疎-Merged"),
         !Year %in% 2009) %>%
  mutate(Kaso.fusion = factor(Kaso.fusion, levels = c("Normal",
                                                           "みなし過疎",
                                                           "一部過疎",
                                                           "全部過疎",
                                                           "全部過疎-Merged"), 
                      labels = c("Normal", "Quasi-depopulating", 
                                 "Partly depopulating",
                                 "Fully depopulating",
                                 "Fully depopulating (merged)"))) %>%
  group_by(Kaso.fusion) %>%
  dplyr::summarize(`LDP-SMD` = mean(LDP, na.rm=TRUE),
                   `LDP-SMD-relative` = mean(LDP_relative, na.rm=TRUE),
                   `LDP-PR` = mean(LDPPR, na.rm=TRUE),
                   `LDP-PR-relative` = mean(LDPPR_relative, na.rm=TRUE),
                   `LDP-Gap` = mean(LDPDif, na.rm=TRUE),
                   `LDP-Gap-relative` = mean(LDPDif_relative, na.rm=TRUE),
                   Turnout = mean(Turnout, na.rm=TRUE),
                   `Turnout-relative` = mean(Turnout_relative, na.rm=TRUE),
                   FStrength = mean(Fstrength, na.rm=TRUE),
                   LATperCapita = mean(LATperCapita, na.rm=TRUE),
                   Elderly = mean(EldPop, na.rm=TRUE)
                   #SCapital = mean(social_capital, na.rm=TRUE)
                   ) %>%
  gt(rowname_col = "Kaso.fusion") %>%
  fmt_number(
    columns = 2:12,
    decimals = 3 # decrease decimal places
    ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = "left",
        color = "black",
        weight = px(3)
      )
    ),
    locations = list(
      cells_body(
        columns = c(Turnout)
      ))) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Municipal characteristics**"),
    subtitle = md("*Aggregated by fiscal profiles*")
  ) %>%
    data_color(
    columns = 2:12,
    colors = my_pal
    ) 
#   gtsave(
#     "kaso-merged-detailed-overall.png"
# )
```


# Statistical analysis

```{r echo=FALSE}
# optionally exclude 2009

Elections3 <- Elections3 %>%
  filter(!Year %in% 2009)
```


## Summary statistics

```{r echo=FALSE, results='asis'}
Elections3[,-c(23:28)] %>%
  # Keep numeric variables
  select_if(is.numeric) %>%
  # gather variables
  gather(Variable, value) %>%
  # Summarize by variable
  group_by(Variable) %>%
  # summarise all columns
  summarise(n = sum(!is.na(value)),
            `Mean` = mean(value, na.rm = TRUE),
            `Std. Dev.` = sd(value, na.rm = TRUE),
            `Median` = median(value, na.rm = TRUE),
            `Min.` = min(value, na.rm = TRUE),
            `Max.` = max(value, na.rm = TRUE)) %>%
  gt() %>%
  fmt_number(
    columns = 3:7,
    decimals = 2) %>%
  fmt_number(
    rows = 4,
    columns = 3:7,
    decimals = 0) %>%
  tab_options(
    column_labels.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    table_body.border.bottom.color = "black",
    table_body.hlines.color = "white"
    ) %>%
  tab_header(
    title = md("**Summary statistics**"))

```



## Correlation matrix

```{r echo=FALSE, results='asis'}
Elections3[,-c(6,11,13:15,18:20,22:30)] %>%
  select_if(is.numeric) %>%
  cor(use = "complete.obs") %>% 
  ggcorrplot(hc.order = TRUE, #hierarchical ordering
             type = "lower",
             lab = TRUE,
             lab_size = 4,
             outline.color = "white",
             colors = c("#6D9EC1", "white", "#E46726"),
             sig.level=0.05,
             insig = "blank") +
  theme(plot.background = element_rect(fill = "#303030", color = "#303030"),
        axis.text.x = element_text(colour = "grey", family = "serif", size = 15),
        axis.text.y = element_text(colour = "grey",family = "serif", size = 15),
        legend.title = element_text(color = "white"),
        legend.text = element_text(color = "white"),
        plot.title = element_text(hjust = 0.5, color = "white", face="bold"))
```


## Regressions

### Turnout ratio

```{r echo=FALSE, include=FALSE}
# TurnoutMod1 <- plm(Turnout ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

TurnoutMod2 <- plm(Turnout ~ Year + Fstrength + EldPop + LDP + LATperCapita,
                   index=c("Code","Year"),
                   model = "pooling", data = Elections3)

TurnoutMod3 <- plm(Turnout ~ Year + Fstrength + EldPop + LDP + LATperCapita +
                   Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

# sqrt(car::vif(TurnoutMod3))
```



```{r echo=FALSE, include=FALSE}
# TurnoutMod4 <- plm(Turnout_relative ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

TurnoutMod5 <- plm(Turnout_relative ~ Year + Fstrength + EldPop + LDP + LATperCapita,
                   index=c("Code","Year"),
                   model = "pooling", data = Elections3)

TurnoutMod6 <- plm(Turnout_relative ~ Year + Fstrength + EldPop + LDP + 
                   LATperCapita + Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

#sqrt(car::vif(TurnoutMod6))
```



```{r echo=FALSE, include=FALSE}
turnout.pooled <- plm(Turnout ~ Fstrength + LDP + Kaso.fusion + EldPop,
                  index=c("Code","Year"), data = Elections3, model = "within", effect = "time")

turnout.fe <- plm(Turnout ~ Year + Fstrength + LDP + Kaso.fusion + EldPop,
                  index=c("Code","Year"), data = Elections3, model = "within")

turnout.re <- plm(Turnout ~ Fstrength + LDP + Kaso.fusion + EldPop,
                  index=c("Code","Year"), data = Elections3, 
                  model = "random")
```



```{r turnout2, results='asis', echo=FALSE}
htmlreg(list(TurnoutMod2, TurnoutMod3,
               TurnoutMod5, TurnoutMod6),
       custom.model.names = c("Model 1", "Model 2", "Model 3",
                              "Model 4"),
       custom.coef.names = c("(Intercept)",
                             "2014", "2017", "2021", "Fiscal Strength",
                             "Elderly", "LDP", "LAT per Capita",
                             "Quasi-depopulating",
                             "Partly depopulating", "Fully depopulating",
                             "Fully depopulating (merged)"),
  custom.header = list("Turnout" = 1:2, "Turnout (relative)" = 3:4),
  groups = list("Year dummy (base group = '2012')" = 2:4,
                "Fiscal type (base group = 'Normal')" = 9:12),
       caption = NULL,
       digits = 2,
#       reorder.coef = c(2:8,1),
       include.ercomp = FALSE,
       single.row = FALSE,
       booktabs = TRUE,
       dcolumn = TRUE,
       caption.above = TRUE,
       threeparttable = TRUE,
       use.packages = FALSE,
       stars = c(0.01, 0.05, 0.1),
       label = "tab:Turnout2"
       )
```

<br><br>

### LDP: SMD-Votes

```{r echo=FALSE, include=FALSE}
# LDPMod1 <- plm(LDP ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

LDPMod2 <- plm(LDP ~ Year + Fstrength + EldPop + Turnout + LATperCapita, 
               index=c("Code","Year"), model = "pooling", data = Elections3)

LDPMod3 <- plm(LDP ~ Year + Fstrength + EldPop + Turnout + 
                   LATperCapita + Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

#sqrt(car::vif(LDPMod6))
```

```{r echo=FALSE, include=FALSE}
# LDPMod4 <- plm(LDP_relative ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

LDPMod5 <- plm(LDP_relative ~ Year + Fstrength + EldPop + Turnout + 
                 LATperCapita, index=c("Code","Year"),
               model = "pooling", data = Elections3)

LDPMod6 <- plm(LDP_relative ~ Year + Fstrength + EldPop + Turnout + 
                   LATperCapita + Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

#sqrt(car::vif(LDPMod6))
```


```{r echo=FALSE, include=FALSE}
# ldp.pooled <- plm(LDP ~ Fstrength + Turnout + Kaso.fusion + EldPop,
#                   index=c("Code","Year"), data = Elections3, model = "within", effect = "time")
# 
# ldp.fe <- plm(LDP ~ Fstrength + Turnout + Kaso.fusion + EldPop,
#                   index=c("Code","Year"), data = Elections3, model = "within")
# 
# ldp.re <- plm(LDP ~ Fstrength + Turnout + Kaso.fusion + EldPop,
#                   index=c("Code","Year"), data = Elections3, 
#                   model = "random")
```


```{r ldp2, results='asis', echo=FALSE}
htmlreg(list(LDPMod2, LDPMod3,
             LDPMod5, LDPMod6),
       custom.model.names = c("Model 1", "Model 2", "Model 3",
                              "Model 4"),
       custom.coef.names = c("(Intercept)",
                             "2014", "2017", "2021", "Fiscal Strength",
                             "Elderly", "Turnout", "LAT per Capita",
                             "Quasi-depopulating",
                             "Partly depopulating", "Fully depopulating",
                             "Fully depopulating (merged)"),
       custom.header = list("Turnout" = 1:2, "Turnout (relative)" = 3:4),
       groups = list("Year dummy (base group = '2012')" = 2:4,
                "Fiscal type (base group = 'Normal')" = 9:12),
       caption = NULL,
       digits = 2,
#       reorder.coef = c(1:5,7:12,6,13:16),
       include.ercomp = FALSE,
       single.row = FALSE,
       booktabs = TRUE,
       dcolumn = TRUE,
       caption.above = TRUE,
       threeparttable = TRUE,
       use.packages = FALSE,
       stars = c(0.01, 0.05, 0.1),
       label = "tab:LDP2"
       )
```

<br><br>

### LDP: SMD-PR Difference

```{r echo=FALSE, include=FALSE}
# LDPDifMod1 <- plm(LDPDif ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

LDPDifMod2 <- plm(LDPDif ~ Year + Fstrength + EldPop + Turnout +
                    LATperCapita, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

LDPDifMod3 <- plm(LDPDif ~ Year + Fstrength + EldPop + Turnout + 
                   LATperCapita + Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

#sqrt(car::vif(LDPMod3))
```

```{r echo=FALSE, include=FALSE}
# LDPDifMod4 <- plm(LDPDif_relative ~ Year + Fstrength, index=c("Code","Year"),
#                    model = "pooling", data = Elections3)

LDPDifMod5 <- plm(LDPDif_relative ~ Year + Fstrength + EldPop + Turnout +
                    LATperCapita, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

LDPDifMod6 <- plm(LDPDif_relative ~ Year + Fstrength + EldPop + Turnout + 
                   LATperCapita + Kaso.fusion, index=c("Code","Year"),
                   model = "pooling", data = Elections3)

#sqrt(car::vif(LDPMod3))
```


```{r ldpdif2, results='asis', echo=FALSE}
htmlreg(list(LDPDifMod2, LDPDifMod3, LDPDifMod5, LDPDifMod6),
       custom.model.names = c("Model 1", "Model 2", "Model 3",
                              "Model 4"),
       custom.coef.names = c("(Intercept)",
                             "2014", "2017", "2021", "Fiscal Strength",
                             "Elderly", "Turnout", "LAT per Capita",
                             "Quasi-depopulating",
                             "Partly depopulating", "Fully depopulating",
                             "Fully depopulating (merged)"),
       custom.header = list("Turnout" = 1:2, "Turnout (relative)" = 3:4),
       groups = list("Year dummy (base group = '2012')" = 2:4,
                "Fiscal type (base group = 'Normal')" = 9:12),
       caption = NULL,
       digits = 2,
#       reorder.coef = c(2:8,1),
       include.ercomp = FALSE,
       single.row = FALSE,
       booktabs = TRUE,
       dcolumn = TRUE,
       caption.above = TRUE,
       threeparttable = TRUE,
       use.packages = FALSE,
       stars = c(0.01, 0.05, 0.1),
       label = "tab:LDPDif2"
       )
```


<br><br>


```{r include=FALSE}
projcrs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

d3 <- sf::st_read("GIS/japan_ver81.shp") %>%
  st_transform(CRS("+proj=longlat +datum=WGS84"))

d3 <- d3[,-c(3:5, 8:9)]
colnames(d3)[1] <- "Code"
```


# Cross-sectional spatial models

```{r include=FALSE}
addnbs <- function(sp.sample){

    queen_nb <- poly2nb(d6, row.names=d6$Code, queen=TRUE)

    count = card(queen_nb)
    if(!any(count==0)){
        return(queen_nb)
    }

    ## get nearest neighbour index, use centroids:
    nnbs = knearneigh(coordinates(sp.sample))$nn

    no_edges_from = which(count==0)
    for(i in no_edges_from){
        queen_nb[[i]] = nnbs[i]
    }
    return(queen_nb)
}
```


```{r include=FALSE}
Elections2021 <- Elections3 %>%
  filter(Year %in% 2021)

d5 <- d3 %>%
  filter(Code %in% Elections2021$Code)


d5 <- st_make_valid(d5)
d6 <- as(d5, "Spatial")

nb_q2 <- addnbs(d6) 
nb_B2 <- nb2listw(nb_q2, style="W", zero.policy=TRUE)
```


```{r include=FALSE}
fm_turnout <- Turnout ~ Fstrength + EldPop + LDP + LATperCapita + Kaso.fusion
fm_turnout_rel <- Turnout_relative ~ Fstrength + EldPop + LDP + LATperCapita + Kaso.fusion

fm_LDP <- LDP ~ Fstrength + EldPop + Turnout + LATperCapita + Kaso.fusion
fm_LDP_rel <- LDP_relative ~ Fstrength + EldPop + Turnout + LATperCapita + Kaso.fusion
```


## Turnout ratio 

### 2021 elections

```{r include=FALSE}
sp_err_turnout_2021 <- errorsarlm(fm_turnout, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_lag_turnout_2021 <- lagsarlm(fm_turnout, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_sacsar_turnout_2021 <- sacsarlm(fm_turnout, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)



sp_err_turnout_rel_2021 <- errorsarlm(fm_turnout_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_lag_turnout_rel_2021 <- lagsarlm(fm_turnout_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_sacsar_turnout_rel_2021 <- sacsarlm(fm_turnout_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)
```


```{r turnout-2021, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1761", "1761", "1761", "1761", "1761", "1761")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "LDP" = "LDP",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2021,
                  "Spatial Error" = sp_err_turnout_2021, 
                  "Lag + Error" = sp_sacsar_turnout_2021,
                  "Spatial Lag" = sp_lag_turnout_rel_2021,
                  "Spatial Error" = sp_err_turnout_rel_2021, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2021),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2017 elections

```{r include=FALSE}
addnbs3 <- function(sp.sample){

    queen_nb <- poly2nb(d2017, row.names=d2017$Code, queen=TRUE)

    count = card(queen_nb)
    if(!any(count==0)){
        return(queen_nb)
    }

    ## get nearest neighbour index, use centroids:
    nnbs = knearneigh(coordinates(sp.sample))$nn

    no_edges_from = which(count==0)
    for(i in no_edges_from){
        queen_nb[[i]] = nnbs[i]
    }
    return(queen_nb)
}
```

```{r include=FALSE}
Elections2017 <- Elections3 %>%
  filter(Year %in% 2017)

d2017 <- d3 %>%
  filter(Code %in% Elections2017$Code)


d2017 <- st_make_valid(d2017)
d2017 <- as(d2017, "Spatial")

nb_q4 <- addnbs3(d2017) 
nb_B4 <- nb2listw(nb_q4, style="W", zero.policy=TRUE)
```


```{r include=FALSE}
sp_err_turnout_2017 <- errorsarlm(fm_turnout, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_lag_turnout_2017 <- lagsarlm(fm_turnout, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_sacsar_turnout_2017 <- sacsarlm(fm_turnout, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)



sp_err_turnout_rel_2017 <- errorsarlm(fm_turnout_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_lag_turnout_rel_2017 <- lagsarlm(fm_turnout_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_sacsar_turnout_rel_2017 <- sacsarlm(fm_turnout_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)
```


```{r turnout-2017, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1787", "1787", "1787", "1787", "1787", "1787")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "LDP" = "LDP",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2017,
                  "Spatial Error" = sp_err_turnout_2017, 
                  "Lag + Error" = sp_sacsar_turnout_2017,
                  "Spatial Lag" = sp_lag_turnout_rel_2017,
                  "Spatial Error" = sp_err_turnout_rel_2017, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2017),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2014 elections

```{r include=FALSE}
addnbs4 <- function(sp.sample){

    queen_nb <- poly2nb(d2014, row.names=d2014$Code, queen=TRUE)

    count = card(queen_nb)
    if(!any(count==0)){
        return(queen_nb)
    }

    ## get nearest neighbour index, use centroids:
    nnbs = knearneigh(coordinates(sp.sample))$nn

    no_edges_from = which(count==0)
    for(i in no_edges_from){
        queen_nb[[i]] = nnbs[i]
    }
    return(queen_nb)
}
```

```{r include=FALSE}
Elections2014 <- Elections3 %>%
  filter(Year %in% 2014)

d2014 <- d3 %>%
  filter(Code %in% Elections2014$Code)


d2014 <- st_make_valid(d2014)
d2014 <- as(d2014, "Spatial")

nb_q5 <- addnbs4(d2014) 
nb_B5 <- nb2listw(nb_q5, style="W", zero.policy=TRUE)
```


```{r include=FALSE}
sp_err_turnout_2014 <- errorsarlm(fm_turnout, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_lag_turnout_2014 <- lagsarlm(fm_turnout, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_sacsar_turnout_2014 <- sacsarlm(fm_turnout, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)



sp_err_turnout_rel_2014 <- errorsarlm(fm_turnout_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_lag_turnout_rel_2014 <- lagsarlm(fm_turnout_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_sacsar_turnout_rel_2014 <- sacsarlm(fm_turnout_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)
```


```{r turnout-2014, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1809", "1809", "1809", "1809", "1809", "1809")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "LDP" = "LDP",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2014,
                  "Spatial Error" = sp_err_turnout_2014, 
                  "Lag + Error" = sp_sacsar_turnout_2014,
                  "Spatial Lag" = sp_lag_turnout_rel_2014,
                  "Spatial Error" = sp_err_turnout_rel_2014, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2014),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2012 elections

```{r include=FALSE}
addnbs5 <- function(sp.sample){

    queen_nb <- poly2nb(d2012, row.names=d2012$Code, queen=TRUE)

    count = card(queen_nb)
    if(!any(count==0)){
        return(queen_nb)
    }

    ## get nearest neighbour index, use centroids:
    nnbs = knearneigh(coordinates(sp.sample))$nn

    no_edges_from = which(count==0)
    for(i in no_edges_from){
        queen_nb[[i]] = nnbs[i]
    }
    return(queen_nb)
}
```

```{r include=FALSE}
Elections2012 <- Elections3 %>%
  filter(Year %in% 2012)

d2012 <- d3 %>%
  filter(Code %in% Elections2012$Code)


d2012 <- st_make_valid(d2012)
d2012 <- as(d2012, "Spatial")

nb_q6 <- addnbs5(d2012) 
nb_B6 <- nb2listw(nb_q6, style="W", zero.policy=TRUE)
```


```{r include=FALSE}
sp_err_turnout_2012 <- errorsarlm(fm_turnout, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_lag_turnout_2012 <- lagsarlm(fm_turnout, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_sacsar_turnout_2012 <- sacsarlm(fm_turnout, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)



sp_err_turnout_rel_2012 <- errorsarlm(fm_turnout_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_lag_turnout_rel_2012 <- lagsarlm(fm_turnout_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_sacsar_turnout_rel_2012 <- sacsarlm(fm_turnout_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)
```


```{r turnout-2012, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1766", "1766", "1766", "1766", "1766", "1766")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "LDP" = "LDP",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2012,
                  "Spatial Error" = sp_err_turnout_2012, 
                  "Lag + Error" = sp_sacsar_turnout_2012,
                  "Spatial Lag" = sp_lag_turnout_rel_2012,
                  "Spatial Error" = sp_err_turnout_rel_2012, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2012),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


## LDP votes

### 2021 elections

```{r include=FALSE}
sp_err_LDP_2021 <- errorsarlm(fm_LDP, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_lag_LDP_2021 <- lagsarlm(fm_LDP, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_sacsar_LDP_2021 <- sacsarlm(fm_LDP, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)



sp_err_LDP_rel_2021 <- errorsarlm(fm_LDP_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_lag_LDP_rel_2021 <- lagsarlm(fm_LDP_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)

sp_sacsar_LDP_rel_2021 <- sacsarlm(fm_LDP_rel, data = Elections2021, 
                          listw = nb_B2,
                          zero.policy = TRUE)
```


```{r ldp-2021, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1761", "1761", "1761", "1761", "1761", "1761")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "Turnout" = "Turnout",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2021,
                  "Spatial Error" = sp_err_turnout_2021, 
                  "Lag + Error" = sp_sacsar_turnout_2021,
                  "Spatial Lag" = sp_lag_turnout_rel_2021,
                  "Spatial Error" = sp_err_turnout_rel_2021, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2021),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2017 elections

```{r include=FALSE}
sp_err_LDP_2017 <- errorsarlm(fm_LDP, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_lag_LDP_2017 <- lagsarlm(fm_LDP, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_sacsar_LDP_2017 <- sacsarlm(fm_LDP, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)



sp_err_LDP_rel_2017 <- errorsarlm(fm_LDP_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_lag_LDP_rel_2017 <- lagsarlm(fm_LDP_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)

sp_sacsar_LDP_rel_2017 <- sacsarlm(fm_LDP_rel, data = Elections2017, 
                          listw = nb_B4,
                          zero.policy = TRUE)
```


```{r ldp-2017, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1782", "1782", "1782", "1782", "1782", "1782")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "Turnout" = "Turnout",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2017,
                  "Spatial Error" = sp_err_turnout_2017, 
                  "Lag + Error" = sp_sacsar_turnout_2017,
                  "Spatial Lag" = sp_lag_turnout_rel_2017,
                  "Spatial Error" = sp_err_turnout_rel_2017, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2017),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2014 elections

```{r include=FALSE}
sp_err_LDP_2014 <- errorsarlm(fm_LDP, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_lag_LDP_2014 <- lagsarlm(fm_LDP, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_sacsar_LDP_2014 <- sacsarlm(fm_LDP, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)



sp_err_LDP_rel_2014 <- errorsarlm(fm_LDP_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_lag_LDP_rel_2014 <- lagsarlm(fm_LDP_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)

sp_sacsar_LDP_rel_2014 <- sacsarlm(fm_LDP_rel, data = Elections2014, 
                          listw = nb_B5,
                          zero.policy = TRUE)
```


```{r ldp-2014, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1806", "1806", "1806", "1806", "1806", "1806")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "Turnout" = "Turnout",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2014,
                  "Spatial Error" = sp_err_turnout_2014, 
                  "Lag + Error" = sp_sacsar_turnout_2014,
                  "Spatial Lag" = sp_lag_turnout_rel_2014,
                  "Spatial Error" = sp_err_turnout_rel_2014, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2014),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


### 2012 elections

```{r include=FALSE}
sp_err_LDP_2012 <- errorsarlm(fm_LDP, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_lag_LDP_2012 <- lagsarlm(fm_LDP, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_sacsar_LDP_2012 <- sacsarlm(fm_LDP, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)



sp_err_LDP_rel_2012 <- errorsarlm(fm_LDP_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_lag_LDP_rel_2012 <- lagsarlm(fm_LDP_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)

sp_sacsar_LDP_rel_2012 <- sacsarlm(fm_LDP_rel, data = Elections2012, 
                          listw = nb_B6,
                          zero.policy = TRUE)
```


```{r ldp-2012, results='asis', echo=FALSE}
rows <- tribble(~term, ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                ~`Spatial Lag`,  ~`Spatial Error`, ~`Lag + Error`,
                'Num.Obs',        "1766", "1766", "1766", "1766", "1766", "1766")
attr(rows, 'position') <- c(23)

cm = c("(Intercept)" = "(Intercept)",
       "Fstrength" = "Fiscal strength", 
       "EldPop" = "Elderly",
       "Turnout" = "Turnout",
       "LATperCapita" = "LAT per Capita",
       "Kaso.fusionみなし過疎" = "Quasi-depopulating",
       "Kaso.fusion一部過疎" = "Partly depopulating",
       "Kaso.fusion全部過疎" = "Fully depopulating",
       "Kaso.fusion全部過疎-Merged" = "Fully depopulating (merged)",
       "rho" = "Lambda", 
       "lambda" = "Rho")


modelsummary(list("Spatial Lag" = sp_lag_turnout_2012,
                  "Spatial Error" = sp_err_turnout_2012, 
                  "Lag + Error" = sp_sacsar_turnout_2012,
                  "Spatial Lag" = sp_lag_turnout_rel_2012,
                  "Spatial Error" = sp_err_turnout_rel_2012, 
                  "Lag + Error" = sp_sacsar_turnout_rel_2012),
             stars = TRUE,
             add_rows = rows,
             coef_map = cm
             ) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 11, 16) %>%
  row_spec(19, background = 'lightblue') %>%
  row_spec(21, background = 'lightblue')
```


<br><br>

# Panel spatial models

```{r include=FALSE}
ElectionsSMD4 <- Elections3[,-c(6,11,13,21)]

ElectionsSMD5 <- ElectionsSMD4[complete.cases(ElectionsSMD4), ]

ElectionsSMD5 <- ElectionsSMD5 %>% 
  mutate(Year=droplevels(Year))

ElectionsSMD6 <- make.pbalanced(ElectionsSMD5, balance.type = "shared.individuals", index = c("Code", "Year"))
```


```{r include=FALSE}
d7 <- d3 %>%
  filter(Code %in% ElectionsSMD6$Code)

ElectionsSMD6 <- ElectionsSMD6 %>%
  filter(Code %in% d7$Code)

ElectionsSMD6 <- pdata.frame(ElectionsSMD6, 
                             index = c("Code", "Year"), 
                             drop.index = FALSE, row.names = TRUE,
                             stringsAsFactors = default.stringsAsFactors(),
                         replace.non.finite = TRUE,
                         drop.NA.series = TRUE, drop.const.series = FALSE,
                         drop.unused.levels = TRUE)

d7 <- st_make_valid(d7)
d8 <- as(d7, "Spatial")
```


```{r include=FALSE}
addnbs2 <- function(sp.sample){

    queen_nb <- poly2nb(d8, row.names=d8$Code, queen=TRUE)

    count = card(queen_nb)
    if(!any(count==0)){
        return(queen_nb)
    }

    ## get nearest neighbour index, use centroids:
    nnbs = knearneigh(coordinates(sp.sample))$nn

    no_edges_from = which(count==0)
    for(i in no_edges_from){
        queen_nb[[i]] = nnbs[i]
    }
    return(queen_nb)
}
```


```{r include=FALSE}
nb_q3 <- addnbs2(d8) 
nb_B3 <- nb2listw(nb_q3, style="B", zero.policy=TRUE) # alternatively, style="W"
```


```{r include=FALSE}
fm1 <- Turnout ~ factor(Year) + Fstrength + EldPop + 
  LDP + LATperCapita + factor(Kaso.fusion)

fm2 <- Turnout_relative ~ factor(Year) + Fstrength + EldPop + 
  LDP + LATperCapita + factor(Kaso.fusion)

fm3 <- LDP ~ factor(Year) + Fstrength + EldPop + 
  Turnout + LATperCapita + Kaso.fusion

fm4 <- LDP_relative ~ factor(Year) + Fstrength + EldPop + 
  Turnout + LATperCapita + Kaso.fusion
```


```{r include=FALSE}
# spatial lag

sp_lag_turnout <- spml(fm1, data = ElectionsSMD6, index = c("Code", "Year"), listw = nb_B3,
                  lag = TRUE, spatial.error = "none", model = "within", 
                  effect = "individual", 
                  na.action = na.exclude(), zero.policy = TRUE, legacy = FALSE)

sp_lag_turnout_sum <- summary(sp_lag_turnout)


sp_lag_turnout_rel <- spml(fm2, data = ElectionsSMD6, index = c("Code", "Year"), listw = nb_B3,
                  lag = TRUE, spatial.error = "none", model = "within", 
                  effect = "individual", 
                  na.action = na.exclude(), zero.policy = TRUE, legacy = FALSE)

sp_lag_turnout_rel_sum <- summary(sp_lag_turnout_rel)


sp_lag_LDP <- spml(fm3, data = ElectionsSMD6, index = c("Code", "Year"), listw = nb_B3,
                  lag = TRUE, spatial.error = "none", model = "within", 
                  effect = "individual", 
                  na.action = na.exclude(), zero.policy = TRUE, legacy = FALSE)

sp_lag_LDP_sum <- summary(sp_lag_LDP)


sp_lag_LDP_rel <- spml(fm4, data = ElectionsSMD6, index = c("Code", "Year"), 
                          listw = nb_B3,
                  lag = TRUE, spatial.error = "none", model = "within", 
                  effect = "individual", 
                  na.action = na.exclude(), zero.policy = TRUE, legacy = FALSE)

sp_lag_LDP_rel_sum <- summary(sp_lag_LDP_rel)
```


```{r include=FALSE}
# spatial error
sp_er_turnout <- spml(fm1, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = FALSE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sp_er_turnout_sum <- summary(sp_er_turnout)


sp_er_turnout_rel <- spml(fm2, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = FALSE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sp_er_turnout_rel_sum <- summary(sp_er_turnout_rel)


sp_er_LDP <- spml(fm3, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = FALSE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sp_er_LDP_sum <- summary(sp_er_LDP)


sp_er_LDP_rel <- spml(fm4, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = FALSE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sp_er_LDP_rel_sum <- summary(sp_er_LDP_rel)
```


```{r include=FALSE}
# SARAR

sarar_turnout <- spml(fm1, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = TRUE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sarar_turnout_sum <- summary(sarar_turnout)

sarar_turnout_rel <- spml(fm2, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = TRUE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sarar_turnout_rel_sum <- summary(sarar_turnout_rel)



sarar_LDP <- spml(fm3, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = TRUE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sarar_LDP_sum <- summary(sarar_LDP)


sarar_LDP_rel <- spml(fm3, data = ElectionsSMD6, index = c("Code", "Year"), 
                    listw = nb_B3,
                    lag = TRUE, 
                    spatial.error = "b", 
                    model = "within", 
                    effect = "individual", 
                    na.action = na.exclude(), 
                    zero.policy = TRUE, legacy = FALSE)

sarar_LDP_rel_sum <- summary(sarar_LDP_rel)
```



## Turnout ratio 


```{r turnout-spatial, results='asis', echo=FALSE}
tbl_sp_panel <- as.data.frame(cbind(sp_lag_turnout_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sp_er_turnout_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sarar_turnout_sum$CoefTable[c(3:13,2), c(1, 2, 4)]))

tbl_sp_panel <- rbind(tbl_sp_panel,
                      c(rep(NA,6), sarar_turnout_sum$CoefTable[1, c(1, 2, 4)]))

names(tbl_sp_panel) <- c('Est_lag', 'SE_lag', 'Pvalue_lag',
                         'Est_err', 'SE_err','Pvalue_err',
                         'Est_errlag', 'SE_errlag', 'Pvalue_errlag')

reg_sp_panel <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'lambda', 'NA'
           ),
  estimate = tbl_sp_panel$Est_lag,
  std.error = tbl_sp_panel$SE_lag,
  p.value = tbl_sp_panel$Pvalue_lag)

er_panel <- data.frame(
  term = c( 
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'NA'
           ),
  estimate = tbl_sp_panel$Est_err,
  std.error = tbl_sp_panel$SE_err,
  p.value = tbl_sp_panel$Pvalue_err)

reg_sp_lag_error_panel <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'lambda'
           ),
  estimate = tbl_sp_panel$Est_errlag,
  std.error = tbl_sp_panel$SE_errlag,
  p.value = tbl_sp_panel$Pvalue_errlag)


gl_V <- data.frame(
  Observations = "6220")

ar <- as.data.frame(rbind(c("R2", (round(sp_lag_turnout_sum$rsqr,2)), 
                            (round(sp_er_turnout_sum$rsqr,2)), 
                            (round(sarar_turnout_sum$rsqr,2)))))

mod_grp_V <- list(tidy = reg_sp_panel, glance = gl_V)
class(mod_grp_V) <- "modelsummary_list"

mod_grp_V1 <- list(tidy = er_panel, glance = gl_V)
class(mod_grp_V1) <- "modelsummary_list"

mod_grp_V2 <- list(tidy = reg_sp_lag_error_panel, glance = gl_V)
class(mod_grp_V2) <- "modelsummary_list"
```




```{r turnout-spatial-rel, results='asis', echo=FALSE}
tbl_sp_panel <- as.data.frame(cbind(sp_lag_turnout_rel_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sp_er_turnout_rel_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sarar_turnout_rel_sum$CoefTable[c(3:13,2), c(1, 2, 4)]))

tbl_sp_panel <- rbind(tbl_sp_panel,
                      c(rep(NA,6), sarar_turnout_rel_sum$CoefTable[1, c(1, 2, 4)]))

names(tbl_sp_panel) <- c('Est_lag', 'SE_lag', 'Pvalue_lag',
                         'Est_err', 'SE_err','Pvalue_err',
                         'Est_errlag', 'SE_errlag', 'Pvalue_errlag')

reg_sp_panel <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'lambda', 'NA'
           ),
  estimate = tbl_sp_panel$Est_lag,
  std.error = tbl_sp_panel$SE_lag,
  p.value = tbl_sp_panel$Pvalue_lag)

er_panel <- data.frame(
  term = c( 
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'NA'
           ),
  estimate = tbl_sp_panel$Est_err,
  std.error = tbl_sp_panel$SE_err,
  p.value = tbl_sp_panel$Pvalue_err)

reg_sp_lag_error_panel <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'LDP (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'lambda'
           ),
  estimate = tbl_sp_panel$Est_errlag,
  std.error = tbl_sp_panel$SE_errlag,
  p.value = tbl_sp_panel$Pvalue_errlag)


gl_V <- data.frame(
  Observations = "6220")

ar <- as.data.frame(rbind(c("R2", 
                            (round(sp_lag_turnout_sum$rsqr,2)), 
                            (round(sp_er_turnout_sum$rsqr,2)), 
                            (round(sarar_turnout_sum$rsqr,2)),
                            (round(sp_lag_turnout_rel_sum$rsqr,2)), 
                            (round(sp_er_turnout_rel_sum$rsqr,2)), 
                            (round(sarar_turnout_rel_sum$rsqr,2)))))

mod_grp_V3 <- list(tidy = reg_sp_panel, glance = gl_V)
class(mod_grp_V3) <- "modelsummary_list"

mod_grp_V4 <- list(tidy = er_panel, glance = gl_V)
class(mod_grp_V4) <- "modelsummary_list"

mod_grp_V5 <- list(tidy = reg_sp_lag_error_panel, glance = gl_V)
class(mod_grp_V5) <- "modelsummary_list"


modelsummary(list("Spatial Lag" = mod_grp_V,
             "Spatial Error" = mod_grp_V1,
             "Lag + Error" = mod_grp_V2,
             "Spatial Lag" = mod_grp_V3,
             "Spatial Error" = mod_grp_V4,
             "Lag + Error" = mod_grp_V5), 
             add_rows = ar, stars = T, 
             output = "kableExtra",
             fmt = 3) %>%
  add_header_above(c(" " = 1, "Turnout" = 3, "Turnout (relative)" = 3)) %>%
  pack_rows("Year dummy (base group = ‘2012’)", 1, 6) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 15, 21) %>%
  row_spec(23, background = 'lightblue') %>%
  row_spec(25, background = 'lightblue') %>%
  kable_styling(full_width = T)
```


## LDP votes 

```{r ldp-spatial, results='asis', echo=FALSE}
tbl_sp_panel_LDP <- as.data.frame(cbind(sp_lag_LDP_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sp_er_LDP_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sarar_LDP_sum$CoefTable[c(3:13,2), c(1, 2, 4)]))

tbl_sp_panel_LDP <- rbind(tbl_sp_panel_LDP,
                      c(rep(NA,6), sarar_LDP_sum$CoefTable[1, c(1, 2, 4)]))

names(tbl_sp_panel_LDP) <- c('Est_lag', 'SE_lag', 'Pvalue_lag',
                         'Est_err', 'SE_err','Pvalue_err',
                         'Est_errlag', 'SE_errlag', 'Pvalue_errlag')

reg_sp_panel_ldp <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'lambda', 'NA'
           ),
  estimate = tbl_sp_panel_LDP$Est_lag,
  std.error = tbl_sp_panel_LDP$SE_lag,
  p.value = tbl_sp_panel_LDP$Pvalue_lag)

er_panel_ldp <- data.frame(
  term = c( 
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'NA'
           ),
  estimate = tbl_sp_panel_LDP$Est_err,
  std.error = tbl_sp_panel_LDP$SE_err,
  p.value = tbl_sp_panel_LDP$Pvalue_err)

reg_sp_lag_error_panel_ldp <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'lambda'
           ),
  estimate = tbl_sp_panel_LDP$Est_errlag,
  std.error = tbl_sp_panel_LDP$SE_errlag,
  p.value = tbl_sp_panel_LDP$Pvalue_errlag)


gl_V <- data.frame(
  Observations = "6220")

ar <- as.data.frame(rbind(c("R2", (round(sp_lag_LDP_sum$rsqr,2)), 
                            (round(sp_er_LDP_sum$rsqr,2)), 
                            (round(sarar_LDP_sum$rsqr,2)))))

mod_grp_V <- list(tidy = reg_sp_panel_ldp, glance = gl_V)
class(mod_grp_V) <- "modelsummary_list"

mod_grp_V1 <- list(tidy = er_panel_ldp, glance = gl_V)
class(mod_grp_V1) <- "modelsummary_list"

mod_grp_V2 <- list(tidy = reg_sp_lag_error_panel_ldp, glance = gl_V)
class(mod_grp_V2) <- "modelsummary_list"
```



```{r ldp-spatial-rel, results='asis', echo=FALSE}
tbl_sp_panel_LDP <- as.data.frame(cbind(sp_lag_LDP_rel_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sp_er_LDP_rel_sum$CoefTable[c(2:12,1), c(1, 2, 4)],
                                    sarar_LDP_rel_sum$CoefTable[c(3:13,2), c(1, 2, 4)]))

tbl_sp_panel_LDP <- rbind(tbl_sp_panel_LDP,
                      c(rep(NA,6), sarar_LDP_rel_sum$CoefTable[1, c(1, 2, 4)]))

names(tbl_sp_panel_LDP) <- c('Est_lag', 'SE_lag', 'Pvalue_lag',
                         'Est_err', 'SE_err','Pvalue_err',
                         'Est_errlag', 'SE_errlag', 'Pvalue_errlag')

reg_sp_panel_ldp <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'lambda', 'NA'
           ),
  estimate = tbl_sp_panel_LDP$Est_lag,
  std.error = tbl_sp_panel_LDP$SE_lag,
  p.value = tbl_sp_panel_LDP$Pvalue_lag)

er_panel_ldp <- data.frame(
  term = c( 
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'NA'
           ),
  estimate = tbl_sp_panel_LDP$Est_err,
  std.error = tbl_sp_panel_LDP$SE_err,
  p.value = tbl_sp_panel_LDP$Pvalue_err)

reg_sp_lag_error_panel_ldp <- data.frame(
  term = c(
           '2014', '2017', '2021',
           'FStrength',
           'Elderly', 'Turnout (relative)', 'LAT per Capita',
           'Quasi-depopulating ', 'Partly depopulating',
           "Fully depopulating", "Fully depopulating (merged)",
           'Rho', 'lambda'
           ),
  estimate = tbl_sp_panel_LDP$Est_errlag,
  std.error = tbl_sp_panel_LDP$SE_errlag,
  p.value = tbl_sp_panel_LDP$Pvalue_errlag)


gl_V <- data.frame(
  Observations = "6220")

ar <- as.data.frame(rbind(c("R2", 
                            (round(sp_lag_LDP_sum$rsqr,2)), 
                            (round(sp_er_LDP_sum$rsqr,2)), 
                            (round(sarar_LDP_sum$rsqr,2)),
                            (round(sp_lag_LDP_rel_sum$rsqr,2)), 
                            (round(sp_er_LDP_rel_sum$rsqr,2)), 
                            (round(sarar_LDP_rel_sum$rsqr,2)))))

mod_grp_V3 <- list(tidy = reg_sp_panel_ldp, glance = gl_V)
class(mod_grp_V3) <- "modelsummary_list"

mod_grp_V4 <- list(tidy = er_panel_ldp, glance = gl_V)
class(mod_grp_V4) <- "modelsummary_list"

mod_grp_V5 <- list(tidy = reg_sp_lag_error_panel_ldp, glance = gl_V)
class(mod_grp_V5) <- "modelsummary_list"


modelsummary(list("Spatial Lag" = mod_grp_V,
             "Spatial Error" = mod_grp_V1,
             "Lag + Error" = mod_grp_V2,
             "Spatial Lag" = mod_grp_V3,
             "Spatial Error" = mod_grp_V4,
             "Lag + Error" = mod_grp_V5),
             add_rows = ar, stars = T, 
             output = "kableExtra",
             fmt = 3) %>%
  add_header_above(c(" " = 1, "LDP" = 3, "LDP (relative)" = 3)) %>%
  pack_rows("Year dummy (base group = ‘2012’)", 1, 6) %>%
  pack_rows("Fiscal type (base group = ‘Normal’)", 15, 21) %>%
  row_spec(23, background = 'lightblue') %>%
  row_spec(25, background = 'lightblue') %>%
  kable_styling(full_width = T)
```



```{r include=FALSE}
# Pref <- read.csv("GIS/JPref2.csv", stringsAsFactors = FALSE)
# colnames(Pref)[1] <- "Code"
# 
# PrefMap <- sf::st_read("GIS/JPref.shp") %>%
#   st_transform(CRS("+proj=longlat +datum=WGS84"))
# 
# PrefMap2 <- as(PrefMap, "Spatial")
# 
# coord2 <- as.data.frame(coordinates(spTransform(PrefMap2, 
#                                                 CRS("+proj=longlat +datum=WGS84"))))
# PrefCoord <- cbind(Pref, coord2)
# 
# senkyoku2017 <- rgdal::readOGR("GIS/senkyoku289/senkyoku289.shp", encoding = "shift-jis")
# senkyoku2017 <- st_as_sf(senkyoku2017)
# senkyoku2017$kucode <- sprintf("%05s", senkyoku2017$kucode)
# 
# senkyoku2017 <- senkyoku2017 %>%
#   arrange(kucode)
# 
# senkyoku2017$ken <- as.numeric(senkyoku2017$ken)
# senkyoku2017$ku <- as.numeric(senkyoku2017$ku)
# 
# senkyoku2014 <- rgdal::readOGR("GIS/senkyoku295/senkyoku295.shp", encoding = "shift-jis")
# senkyoku2014 <- st_as_sf(senkyoku2014)
# colnames(senkyoku2014)[1] <- "kucode"
# 
# senkyoku2014 <- senkyoku2014 %>%
#   arrange(kucode)
# 
# senkyoku2014 <- senkyoku2014[-c(3:16)]
# 
# 
# senkyoku1996 <- rgdal::readOGR("GIS/senkyoku300/senkyoku300.shp", encoding = "shift-jis")
# senkyoku1996 <- st_as_sf(senkyoku1996)
# colnames(senkyoku1996)[1] <- "kucode"
# 
# senkyoku1996 <- senkyoku1996 %>%
#   arrange(kucode)
# 
# senkyoku1996 <- senkyoku1996[-c(3:16)]
```


```{r include=FALSE}
# Elections3$PrefNumber <- Pref$Code[match(Elections3$Pref, Pref$Jpref)]
# 
# Elections3 <- Elections3 %>%
#   separate(kuname, 
#            into = c("EPref", "ku"), 
#            sep = "(?<=[A-Za-z])(?=[0-9])"
#            )
# 
# 
# Elections4 <- merge(x = Elections3, y = d3[,c(1,5)], by = "Code", all.x = TRUE)
# Elections4 <- st_as_sf(x = Elections4, crs = projcrs)
```

```{r include=FALSE}
# Elections3 %>%
#   filter(Year %in% 2021) %>%
#   summarise(Turnout = quantile(Turnout, c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1), 
#                                na.rm = TRUE))
```

```{r include=FALSE}
# Elections3$ku <- as.numeric(Elections3$ku)
# 
# Elections2021 <- Elections3 %>%
#   filter(Year %in% 2021) %>%
#   mutate(District = paste0(EPref,ku)) 
# 
# Elections2021 <- Elections2021 %>%
#   left_join(senkyoku2017[,c(3:5)], by = c("PrefNumber" = "ken",
#                                "ku" = "ku"))
# 
# Elections2021 <- st_as_sf(x = Elections2021, crs = projcrs)
# 
# 
# Elections2021Dist <- Elections3 %>%
#   filter(Year %in% 2021) %>%
#   mutate(District = paste0(EPref,ku)) %>% 
#   distinct(District, .keep_all = TRUE) %>%
#   left_join(senkyoku2017[,c(3:5)], by = c("PrefNumber" = "ken",
#                                "ku" = "ku"))
# 
# Elections2021Dist <- st_as_sf(x = Elections2021Dist, crs = projcrs)
```


```{r include=FALSE}
align_legend <- function(p, hjust = 0.5)
{
  # extract legend
  g <- cowplot::plot_to_gtable(p)
  grobs <- g$grobs
  legend_index <- which(sapply(grobs, function(x) x$name) == "guide-box")
  legend <- grobs[[legend_index]]

  # extract guides table
  guides_index <- which(sapply(legend$grobs, function(x) x$name) == "layout")

  # there can be multiple guides within one legend box  
  for (gi in guides_index) {
    guides <- legend$grobs[[gi]]

    # add extra column for spacing
    # guides$width[5] is the extra spacing from the end of the legend text
    # to the end of the legend title. If we instead distribute it by `hjust:(1-hjust)` on
    # both sides, we get an aligned legend
    spacing <- guides$width[5]
    guides <- gtable::gtable_add_cols(guides, hjust*spacing, 1)
    guides$widths[6] <- (1-hjust)*spacing
    title_index <- guides$layout$name == "title"
    guides$layout$l[title_index] <- 2

    # reconstruct guides and write back
    legend$grobs[[gi]] <- guides
  }

  # reconstruct legend and write back
  g$grobs[[legend_index]] <- legend
  g
}
```



```{r include=FALSE}
## Turnout

### 2021

# (mainland <- Elections4 %>%
#    filter(Year %in% 2021) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile), colour = NA) +
#    geom_sf(data = PrefMap,
#            fill = NA,
#            color = "black",
#            size = 0.1) +
#   coord_sf(xlim = c(128, 147), 
#            ylim = c(30.1, 46),
#            expand = FALSE) +
#   scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10),
#                      labels = c("53%", "57%", "61%",
#                                 "67%", "87%"),
#                      name = "Voters' Turnout") +
#   labs(title = "Turnout Ratio (2021)") +
#   theme_map() +
#   theme(axis.text=element_text(size=22),
#         axis.text.x = element_text(vjust = 0.5, color = 'black'),
#         axis.text.y = element_text(color = 'black'),
#         axis.title.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title=element_text(size=24,face="bold"),
#         legend.position = c(0.85, 0.5),
#         legend.title.align=0.5,
#         plot.title = element_text(hjust = 0.5, size=25,face="bold"),
#         legend.text=element_text(size=12),
#         legend.title=element_text(size=13, face="bold"),
#         legend.margin = margin(8, 8, 8, 8),
#         legend.spacing.y = unit(0.5, 'cm'),
#         legend.key = element_rect(fill = "white"),
#         legend.box.background = element_rect(color="black", size=1),
#         legend.key.width=unit(1.5, "cm"),
#         legend.key.height = unit(1.5, "cm"))
# )
```

```{r include=FALSE}
# (Ryukyu <- Elections4 %>%
#    filter(Year %in% 2021) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile),
#            color = "black", size=0.1) +
#   coord_sf(xlim = c(122.5, 130.5), 
#            ylim = c(23.5, 30.1),
#            expand = FALSE, datum = NA) +
#   labs(title = NULL) +
#    scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10)) +
#   theme(legend.position = "none",
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_text(data = PrefCoord %>%
#                     filter(Code %in% c(47)),
#                   aes(x = V1, y = V2, label = "Okinawa Pref.\n沖縄県"),
#                   size = 10,
#                   alpha = 0.5,
#                   nudge_x = -1.5,
#                   nudge_y = 1.5,
#             family = "HiraKakuPro-W3"))
```

```{r echo=FALSE}
# TurnoutRatio2021 <- mainland +
#     annotation_custom(
#       grob = ggplotGrob(Ryukyu),
#       xmin = 129,
#       xmax = 138,
#       ymin = 36.5,
#       ymax = 47.5
#   ) +
#   annotation_north_arrow(which_north = "grid", location = "br",  
#                          height = unit(4, "cm"), width = unit(4, "cm"),
#                          pad_x = unit(1, "cm"),
#                          pad_y = unit(6, "cm")) +
#   ggsn::scalebar(x.min = 128, x.max = 146.5,
#                    y.min = 31, y.max = 46,
#                    dist = 100, dist_unit = "km",
#                    st.bottom = FALSE, st.color = "black",
#              transform = TRUE, model = "WGS84")
# 
# ggdraw(align_legend(TurnoutRatio2021))
```


```{r include=FALSE}
# ggsave(filename = "Turnout2021.pdf", width = 15, height = 16, units = "in", device = cairo_pdf)
# ggsave(filename = "Turnout2021.png", width = 15, height = 16, units = "in")
```



```{r include=FALSE}
### 2017

# (mainland <- Elections4 %>%
#    filter(Year %in% 2017) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile), colour = NA) +
#    geom_sf(data = PrefMap,
#            fill = NA,
#            color = "black",
#            size = 0.1) +
#   coord_sf(xlim = c(128, 147), 
#            ylim = c(30.1, 46),
#            expand = FALSE) +
#   scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10),
#                      labels = c("50%", "54%", "59%",
#                                 "65%", "97%"),
#                      name = "Voters' Turnout") +
#   labs(title = "Turnout Ratio (2017)") +
#   theme_map() +
#   theme(axis.text=element_text(size=22),
#         axis.text.x = element_text(vjust = 0.5, color = 'black'),
#         axis.text.y = element_text(color = 'black'),
#         axis.title.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title=element_text(size=24,face="bold"),
#         legend.position = c(0.85, 0.5),
#         legend.title.align=0.5,
#         plot.title = element_text(hjust = 0.5, size=25,face="bold"),
#         legend.text=element_text(size=12),
#         legend.title=element_text(size=13, face="bold"),
#         legend.margin = margin(8, 8, 8, 8),
#         legend.spacing.y = unit(0.5, 'cm'),
#         legend.key = element_rect(fill = "white"),
#         legend.box.background = element_rect(color="black", size=1),
#         legend.key.width=unit(1.5, "cm"),
#         legend.key.height = unit(1.5, "cm"))
# )
```

```{r include=FALSE}
# (Ryukyu <- Elections4 %>%
#    filter(Year %in% 2017) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile),
#            color = "black", size=0.1) +
#   coord_sf(xlim = c(122.5, 130.5), 
#            ylim = c(23.5, 30.1),
#            expand = FALSE, datum = NA) +
#   labs(title = NULL) +
#    scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10)) +
#   theme(legend.position = "none",
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_text(data = PrefCoord %>%
#                     filter(Code %in% c(47)),
#                   aes(x = V1, y = V2, label = "Okinawa Pref.\n沖縄県"),
#                   size = 10,
#                   alpha = 0.5,
#                   nudge_x = -1.5,
#                   nudge_y = 1.5,
#             family = "HiraKakuPro-W3"))
```


```{r echo=FALSE}
# TurnoutRatio2017 <- mainland +
#     annotation_custom(
#       grob = ggplotGrob(Ryukyu),
#       xmin = 129,
#       xmax = 138,
#       ymin = 36.5,
#       ymax = 47.5
#   ) +
#   annotation_north_arrow(which_north = "grid", location = "br",  
#                          height = unit(4, "cm"), width = unit(4, "cm"),
#                          pad_x = unit(1, "cm"),
#                          pad_y = unit(6, "cm")) +
#   ggsn::scalebar(x.min = 128, x.max = 146.5,
#                    y.min = 31, y.max = 46,
#                    dist = 100, dist_unit = "km",
#                    st.bottom = FALSE, st.color = "black",
#              transform = TRUE, model = "WGS84")
# 
# ggdraw(align_legend(TurnoutRatio2017))
```


```{r include=FALSE}
# ggsave(filename = "Turnout2017.pdf", width = 15, height = 16, units = "in", device = cairo_pdf)
# ggsave(filename = "Turnout2017.png", width = 15, height = 16, units = "in")
```


```{r include=FALSE}
### 2014

# (mainland <- Elections4 %>%
#    filter(Year %in% 2014) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile), colour = NA) +
#    geom_sf(data = PrefMap,
#            fill = NA,
#            color = "black",
#            size = 0.1) +
#   coord_sf(xlim = c(128, 147), 
#            ylim = c(30.1, 46),
#            expand = FALSE) +
#   scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10),
#                      labels = c("47%", "51%", "56%",
#                                 "63%", "99%"),
#                      name = "Voters' Turnout") +
#   labs(title = "Turnout Ratio (2014)") +
#   theme_map() +
#   theme(axis.text=element_text(size=22),
#         axis.text.x = element_text(vjust = 0.5, color = 'black'),
#         axis.text.y = element_text(color = 'black'),
#         axis.title.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title=element_text(size=24,face="bold"),
#         legend.position = c(0.85, 0.5),
#         legend.title.align=0.5,
#         plot.title = element_text(hjust = 0.5, size=25,face="bold"),
#         legend.text=element_text(size=12),
#         legend.title=element_text(size=13, face="bold"),
#         legend.margin = margin(8, 8, 8, 8),
#         legend.spacing.y = unit(0.5, 'cm'),
#         legend.key = element_rect(fill = "white"),
#         legend.box.background = element_rect(color="black", size=1),
#         legend.key.width=unit(1.5, "cm"),
#         legend.key.height = unit(1.5, "cm"))
# )
```

```{r include=FALSE}
# (Ryukyu <- Elections4 %>%
#    filter(Year %in% 2014) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile),
#            color = "black", size=0.1) +
#   coord_sf(xlim = c(122.5, 130.5), 
#            ylim = c(23.5, 30.1),
#            expand = FALSE, datum = NA) +
#   labs(title = NULL) +
#    scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10)) +
#   theme(legend.position = "none",
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_text(data = PrefCoord %>%
#                     filter(Code %in% c(47)),
#                   aes(x = V1, y = V2, label = "Okinawa Pref.\n沖縄県"),
#                   size = 10,
#                   alpha = 0.5,
#                   nudge_x = -1.5,
#                   nudge_y = 1.5,
#             family = "HiraKakuPro-W3"))
```

```{r echo=FALSE}
# TurnoutRatio2014 <- mainland +
#     annotation_custom(
#       grob = ggplotGrob(Ryukyu),
#       xmin = 129,
#       xmax = 138,
#       ymin = 36.5,
#       ymax = 47.5
#   ) +
#   annotation_north_arrow(which_north = "grid", location = "br",  
#                          height = unit(4, "cm"), width = unit(4, "cm"),
#                          pad_x = unit(1, "cm"),
#                          pad_y = unit(6, "cm")) +
#   ggsn::scalebar(x.min = 128, x.max = 146.5,
#                    y.min = 31, y.max = 46,
#                    dist = 100, dist_unit = "km",
#                    st.bottom = FALSE, st.color = "black",
#              transform = TRUE, model = "WGS84")
# 
# ggdraw(align_legend(TurnoutRatio2014))
```


```{r include=FALSE}
# ggsave(filename = "Turnout2014.pdf", width = 15, height = 16, units = "in", device = cairo_pdf)
# ggsave(filename = "Turnout2014.png", width = 15, height = 16, units = "in")
```


```{r include=FALSE}
### 2012

# (mainland <- Elections4 %>%
#    filter(Year %in% 2012) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile), colour = NA) +
#    geom_sf(data = PrefMap,
#            fill = NA,
#            color = "black",
#            size = 0.1) +
#   coord_sf(xlim = c(128, 147), 
#            ylim = c(30.1, 46),
#            expand = FALSE) +
#   scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10),
#                      labels = c("53%", "56%", "60%",
#                                 "65%", "87%"),
#                      name = "Voters' Turnout") +
#   labs(title = "Turnout Ratio (2012)") +
#   theme_map() +
#   theme(axis.text=element_text(size=22),
#         axis.text.x = element_text(vjust = 0.5, color = 'black'),
#         axis.text.y = element_text(color = 'black'),
#         axis.title.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title=element_text(size=24,face="bold"),
#         legend.position = c(0.85, 0.5),
#         legend.title.align=0.5,
#         plot.title = element_text(hjust = 0.5, size=25,face="bold"),
#         legend.text=element_text(size=12),
#         legend.title=element_text(size=13, face="bold"),
#         legend.margin = margin(8, 8, 8, 8),
#         legend.spacing.y = unit(0.5, 'cm'),
#         legend.key = element_rect(fill = "white"),
#         legend.box.background = element_rect(color="black", size=1),
#         legend.key.width=unit(1.5, "cm"),
#         legend.key.height = unit(1.5, "cm"))
# )
```

```{r include=FALSE}
# (Ryukyu <- Elections4 %>%
#    filter(Year %in% 2012) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile),
#            color = "black", size=0.1) +
#   coord_sf(xlim = c(122.5, 130.5), 
#            ylim = c(23.5, 30.1),
#            expand = FALSE, datum = NA) +
#   labs(title = NULL) +
#    scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10)) +
#   theme(legend.position = "none",
#         axis.title.x = element_blank(),
#         axis.title.y = element_blank(),
#         panel.border = element_rect(colour = "black", fill=NA, size=1)) +
#   geom_text(data = PrefCoord %>%
#                     filter(Code %in% c(47)),
#                   aes(x = V1, y = V2, label = "Okinawa Pref.\n沖縄県"),
#                   size = 10,
#                   alpha = 0.5,
#                   nudge_x = -1.5,
#                   nudge_y = 1.5,
#             family = "HiraKakuPro-W3"))
```

```{r echo=FALSE}
# TurnoutRatio2012 <- mainland +
#     annotation_custom(
#       grob = ggplotGrob(Ryukyu),
#       xmin = 129,
#       xmax = 138,
#       ymin = 36.5,
#       ymax = 47.5
#   ) +
#   annotation_north_arrow(which_north = "grid", location = "br",  
#                          height = unit(4, "cm"), width = unit(4, "cm"),
#                          pad_x = unit(1, "cm"),
#                          pad_y = unit(6, "cm")) +
#   ggsn::scalebar(x.min = 128, x.max = 146.5,
#                    y.min = 31, y.max = 46,
#                    dist = 100, dist_unit = "km",
#                    st.bottom = FALSE, st.color = "black",
#              transform = TRUE, model = "WGS84")
# 
# ggdraw(align_legend(TurnoutRatio2012))
```


```{r include=FALSE}
# ggsave(filename = "Turnout2012.pdf", width = 15, height = 16, units = "in", device = cairo_pdf)
# ggsave(filename = "Turnout2012.png", width = 15, height = 16, units = "in")
```


```{r include=FALSE}
# p <- plot_grid(TurnoutRatio2012, TurnoutRatio2014, 
#                TurnoutRatio2017, TurnoutRatio2021,
#                labels = "AUTO")
# 
# ggsave(filename = "Turnout.pdf", p, device = cairo_pdf)
```



```{r include=FALSE}
## Nagano 2021

# Nagano2021 <- Elections4 %>%
#   filter(Year %in% 2021,
#          EPref %in% "Nagano",
#          ku == 4)
```


```{r echo=FALSE}
# Elections4 %>%
#    filter(Year %in% 2021) %>%
#    mutate(TurnoutDecile = dplyr::ntile(Turnout, 10)) %>%
#    filter(EPref %in% "Nagano") %>%
#    ggplot() +
#    geom_sf(aes(fill = TurnoutDecile), colour = NA) +
#    geom_sf(data = Elections2021Dist %>%
#              filter(EPref %in% "Nagano"),
#            fill = NA,
#            color = "white",
#            size = 1.5) +
#   scale_fill_viridis(option="F", direction = -1,
#                      breaks = c(2, 4, 6, 8, 10),
#                      labels = c("53%", "57%", "61%",
#                                 "67%", "87%"),
#                      name = "Voters' Turnout") +
#   scale_x_continuous(breaks = seq(137.4, 138.8, by = .4)) +
#   geom_sf_label_repel(data = Nagano2021 %>%
#                         filter(Kaso2 %in% "Normal"),
#                   aes(label = Kaso2),
#                   fontface = 'bold',
#                   color = 'black',
#                   size = 5,
#                   box.padding = unit(0.35, "lines"),
#                   point.padding = unit(0.5, "lines"),
#                   fill="springgreen4",
#                   segment.color = 'black',
#                   alpha = 0.8,
#                   fun.geometry = sf::st_centroid) +
#   geom_sf_label_repel(data = Nagano2021 %>%
#                         filter(Kaso2 %in% "Kaso"),
#                   aes(label = Kaso2),
#                   fontface = 'bold',
#                   color = 'white',
#                   size = 5,
#                   box.padding = unit(0.35, "lines"),
#                   point.padding = unit(0.5, "lines"),
#                   fill="red4",
#                   segment.color = 'black',
#                   alpha = 0.8,
#                   fun.geometry = sf::st_centroid) +
#   geom_sf_label_repel(data = Elections2021Dist %>%
#                         filter(EPref %in% "Nagano"),
#                   aes(label = ku),
#                   fontface = 'bold',
#                   color = 'black',
#                   size = 15,
#                   box.padding = unit(0.35, "lines"),
#                   point.padding = unit(0.5, "lines"),
#                   segment.color = 'black',
#                   alpha = 0.8,
#                   fun.geometry = sf::st_centroid) +
#   labs(title = "Turnout Ratio, Nagano-ken (2021)") +
#   theme_map() +
#   theme(axis.text=element_text(size=22),
#         axis.text.x = element_text(vjust = 0.5, color = 'black'),
#         axis.text.y = element_text(color = 'black'),
#         axis.title.y = element_blank(),
#         axis.title.x = element_blank(),
#         axis.title=element_text(size=24,face="bold"),
#         legend.position = c(0.7, 0.1),
#         legend.title.align=0.5,
#         plot.title = element_text(hjust = 0.5, size=25,face="bold"),
#         legend.text=element_text(size=12),
#         legend.title=element_text(size=13, face="bold"),
#         legend.margin = margin(8, 8, 8, 8),
#         legend.spacing.y = unit(0.5, 'cm'),
#         legend.key = element_rect(fill = "white"),
#         legend.box.background = element_rect(color="black", size=1),
#         legend.key.width=unit(1.5, "cm"),
#         legend.key.height = unit(1.5, "cm"))
```

```{r include=FALSE}
# ggsave(filename = "NaganoTurnout2021.pdf", width = 15, height = 16, units = "in", device = cairo_pdf)
# ggsave(filename = "NaganoTurnout2021.png", width = 15, height = 16, units = "in")
```